<?php



class VO_CtrlProfile {
	const _ECP = 'PRO';	// Error Code Prefix
	
	
	/***************************************************************************/
	//
	/***************************************************************************/
  
	public static function profileEdit( WOOOF $wo ) {
	
		wooofTimerStart('profileEditSpecial');
		
		$requestedAction='viewUncontroled';	// TODO: should be edit
		$pageLocation='3';
		$browserTitle='VOICE Edit User Profile';

		$wo = WOOOF::getWOOOF($pageLocation, $requestedAction, $wo);
		if ( $wo === FALSE ) { die('Failed to getWOOOF()'); }
		
		if ( $wo->userData['id'] == '0123456789' ) {
			$wo->handleShowStopperError('505');
		}
		
		$lookUps = WOOOF_Domains::getMultipleDomains($wo, 
			array(
				array('ADDRESS_TYPE','PRS'),
				'DEGREE_TYPE',
				'PERSON_TITLE',
				'SOCIAL_ACCOUNT'
			))
		;
		if ( $lookUps === FALSE ) { $wo->handleShowStopperError(); }
		
		$areas = VO_Various::getAreasLookUp($wo);
		if($areas === FALSE) { $wo->handleShowStopperError(); }
		
		$lookUps['AREA'] = $areas; 
		
		$lookUps = json_encode($lookUps);
		
		// TODO: complete getdata
        $data = VO_Users::getFull($wo, $wo->app->userId);
        if ( $data === FALSE ) { $wo->handleShowStopperError(); }
		$data = json_encode( $data );
		
		//TODO: take formats from person profile
		$dateShowFormat = 'DD/MM/YYYY';
		
        $content = "
		<div id='content-main'></div>

		<script>
        	var data = $data;
        	var lookUps = $lookUps; 
        	var dateShowFormat = '$dateShowFormat';
        	ReactDOM.render(
        		React.createElement(
        			ProfileEdit, 
        			{ data: data, lookUps: lookUps }
        		), 
        		document.getElementById('content-main')
        	);
			/*ReactDOM.render(
				<ProfileEdit data={data} lookUps = {lookUps}/>,
				document.getElementById('voice-user-profile-edit')
			);*/
		</script>
		";
	
		$tpl = array(
				'browserTitle'	=> $browserTitle,
				'content' 		=> $content,
				'errorMessage'	=> '',
				'message'		=> '',
		);
		
		$wo->fetchApplicationFragment('structural/template.php', [], $tpl);
	}	//profileEdit
	
	/***************************************************************************/
	//
	/***************************************************************************/
  
	public static function profileView( WOOOF $wo, $voiceUserId = '' ) {
	
		$requestedAction='viewUncontroled';
		$pageLocation='3';
		$browserTitle='VOICE User Profile Page';
		$wo = WOOOF::getWOOOF($pageLocation, $requestedAction, $wo);
		if ( $wo === FALSE ) { die('Failed to getWOOOF()'); }
		
		VO_CtrlSite::redirectToEditProfileIfNeeded($wo);
		
		if(!$wo->hasContent($voiceUserId)) {
			$voiceUserId = $wo->app->userId;
		} 
		
		$data = VO_Users::getFull($wo, $voiceUserId);
		if ( $data === FALSE ) { $wo->handleShowStopperError(); }
		$data = json_encode( $data );
		
		$content = <<<EOH
		<div id='content-main'></div>

		<script>
			ReactDOM.render(
				React.createElement(
					ProfileView, 
					{ data: $data }
				), 
				document.getElementById('content-main')
			);
			/*
			ReactDOM.render(
				<ProfileView />,
				document.getElementById('content-main')
			);
			*/
		</script>
EOH
	;
	
		$tpl = array(
				'browserTitle'	=> $browserTitle,
				'content' 		=> $content,
				'errorMessage'	=> '',
				'message'		=> '',
		);
		
		
		$wo->fetchApplicationFragment('structural/template.php', [], $tpl);
	
	}	//profileView
	
	/***************************************************************************/
	//
	/***************************************************************************/
  
	/**
	 * 
	 * @param WOOOF $wo
	 * @param array $in
	 * @return [ 'saveOk' => bool, 'userId' => id, 'errors' => array ]
	 */
	public static 
	function mainInfoSave( WOOOF $wo, $in )
	{
		$place = __CLASS__ . '::' . __FUNCTION__;
		
		if ( $wo->userData['id'] == '0123456789' ) {
			$wo->handleShowStopperError('505');
		}
		
		$res =  VO_Users::saveMainInfo($wo, $in);
		
		$avatarRec = $wo->db->getRowByColumn('voice_users', 'personProfileId', $res);
		if($avatarRec === FALSE) { return false; }
		
		$cvFileRec = $wo->db->getRow('person_profiles', $res);
		if($cvFileRec === FALSE) { return false; }
		
		$cvFileObj = $wo->db->getRow('__externalFiles', $cvFileRec['cvFile']);
		if($cvFileObj === FALSE) { return false; }
		
		if ( $res === FALSE ) {
			$out = [
				'saveOk' => false,
				'errors' => $wo->getErrorsAsArrayAndClear()
			];
			$wo->db->rollback();
		}
		
		else {
			$out = [
				'saveOk'	=> true,
				'userId'	=> $res,
				'avatarImg' => $avatarRec['avatarImg'],
				'cvFile'	=> [
					'externalFileId'   => $cvFileObj['id'],
					'fileName'		   => $cvFileObj['fileName'],
					'originalFileName' => $cvFileObj['originalFileName']
				]
			];
			$wo->db->commit();
		}
		
		return $out;
	}	// mainInfoSave
	
	/***************************************************************************/
	//
	/***************************************************************************/
	
	/**
	 *
	 * @param WOOOF $wo
	 * @param array $in
	 * @return [ 'saveOk' => bool, 'addressId' => id, 'errors' => array ]
	 */
	public static
	function saveAddresses( WOOOF $wo, $in )
	{
		$place = __CLASS__ . '::' . __FUNCTION__;
	
		if ( $wo->userData['id'] == '0123456789' ) {
			$wo->handleShowStopperError('505');
		}

		$res =  VO_Addresses::saveAddresses($wo, $in['list'], $in['genericType'], $in['genericId']);
	
		if ( $res === FALSE ) {
			$out = [
				'saveOk' => false,
				'errors' => $wo->getErrorsAsArrayAndClear()
			];
			$wo->db->rollback();
		}
	
		else {
			$out = [
				'saveOk'	=> true,
				'addressId'	=> $res
			];
			$wo->db->commit();
		}
	
		return $out;
	}	// saveAddresses
	
	//
	/***************************************************************************/
	
	/**
	 *
	 * @param WOOOF $wo
	 * @param array $in
	 * @return [ 'saveOk' => bool, 'educationId' => id, 'errors' => array ]
	 */
	public static
	function saveEducations( WOOOF $wo, $in )
	{
		$place = __CLASS__ . '::' . __FUNCTION__;
	
		if ( $wo->userData['id'] == '0123456789' ) {
			$wo->handleShowStopperError('505');
		}
	
		$res = VO_Educations::saveEducations($wo, $in, $wo->app->personProfileId);
	
		if ( $res === FALSE ) {
			$out = [
				'saveOk' => false,
				'errors' => $wo->getErrorsAsArrayAndClear()
			];
			$wo->db->rollback();
		}
	
		else {
			$out = [
				'saveOk'	=> true,
				'educationId'	=> $res
			];
			$wo->db->commit();
		}
	
		return $out;
	}	// saveEducations
	
	/***************************************************************************/
	
	/**
	 *
	 * @param WOOOF $wo
	 * @param array $in
	 * @return [ 'saveOk' => bool, 'accountId' => id, 'errors' => array ]
	 */
	public static
	function saveAccounts( WOOOF $wo, $in )
	{
		$place = __CLASS__ . '::' . __FUNCTION__;
	
		if ( $wo->userData['id'] == '0123456789' ) {
			$wo->handleShowStopperError('505');
		}
	
		$res = VO_Accounts::saveAccounts($wo, $in, $wo->app->personProfileId);
	
		if ( $res === FALSE ) {
			$out = [
				'saveOk' => false,
				'errors' => $wo->getErrorsAsArrayAndClear()
			];
			$wo->db->rollback();
		}
	
		else {
			$out = [
				'saveOk'	=> true,
				'accountId'	=> $res
			];
			$wo->db->commit();
		}
	
		return $out;
	}	// saveAccounts
	
}	// VO_CtrlProfile